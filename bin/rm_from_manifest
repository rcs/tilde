#!/bin/bash


TILDE_DIR="$HOME/.tilde"
ENABLED_DIR="$TILDE_DIR/enabled"
MANIFEST_DIR="$HOME/.tilde/manifests"
REPO_DIR="$HOME/.tilde/repos"
REPO_NAME=$1
THIS_REPO=$REPO_DIR/$REPO_NAME
THIS_MANIFEST=$MANIFEST_DIR/$REPO_NAME

if [ ! -d "$THIS_REPO" ]; then
	echo "E: Couldn't find this repo $THIS_REPO, exiting"
	exit 2
fi
if [ ! -f "$THIS_MANIFEST" ]; then
	echo "E: Couldn't find the manifest file $THIS_MANIFEST, exiting"
	exit 2
fi

to_remove=()
for linked in $(cat "$MANIFEST_DIR/$REPO_NAME"); do
	home_file="$HOME/$linked"
	if [ ! -L "$home_file" ]; then
		echo "W: $home_file is not a symbolic link, probably not ours, leaving it alone"
		continue
	fi

	if [[ ! $(readlink $home_file) =~ ^$THIS_REPO ]]; then
		echo "W: $home_file not linked into this repo, leaving it alone."
		continue
	fi

	echo "Adding $home_file for removal"
	to_remove=("${to_remove[@]}" $home_file)
done

set -o nounset
if [[ ${#to_remove[@]} > 0 ]]; then
	echo "Removing files"
	for file in ${to_remove[@]}; do
		rm "$file"
	done
fi
echo "Removing manifest"
rm "$THIS_MANIFEST"
echo "Removing enabled"
rm "$ENABLED_DIR/$REPO_NAME"

